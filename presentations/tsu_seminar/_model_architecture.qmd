::: {.panel-tabset}

# {{< bi image >}} Figure

::: {#fig-loop-I }
![](imgs/model_architecture/loop_I.svg){width="689px"}

The innermost loop of the model architecture handles the individual ballistic transport of exospheric particles. "Escape" and "Cold Trapping" indicate pure loss mechanisms, which remove the respective particles from the simulation. The orange highlighted paths indicate conversion reactions, which act as loss mechanisms for one exospheric species as well as a source mechanism for one or more other species, e.g. the photodissociation of water into atomic hydrogen and hydroxyl.
:::

# {{< bi code >}} LaTeX
```latex
\newcommand{\n}[1]{\begin{tabular}{c}#1\end{tabular}}
\renewcommand{\vec}[1]{\boldsymbol{\mathbf{#1}}}

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}

\begin{tikzpicture}[
    main/.style={draw, thick, rounded corners=4pt, inner sep=2pt, minimum size=20pt, minimum width=25pt, fill=white},
]

    %::. main nodes
    \node[main] (LAUNCH) at (0,0) {\n{Launch particle at $\sphericalCoordinateAzimuth_0, \sphericalCoordinateElevation_0$ \\ with $\vec\velocity \sim \Velocity_\text{MBF}$}};
    \node[main, below = 0.8 of LAUNCH] (TRAJECTORY) {\n{Calculate landing \\ position $\sphericalCoordinateAzimuth_1, \sphericalCoordinateElevation_1$ \\ and time-of-flight $\Time_f$}};
    \node[main, below = 2 of TRAJECTORY] (LAND) {\n{Landing at $\sphericalCoordinateAzimuth_1, \sphericalCoordinateElevation_1$}};
    \node[main, below = 0.8 of LAND] (SURF) {\n{Surface interactions \\ at $\sphericalCoordinateAzimuth_1, \sphericalCoordinateElevation_1$}};

    %::. main connections
    \draw[latex-, thick] (LAUNCH.70) -- +(0,2.5) node[at end, above] {\n{New particle with \\ weight $\weight = \weight_0$}};

    \draw[-latex, thick] (LAUNCH.270) -- (TRAJECTORY.90);
    \draw[-latex, thick] (TRAJECTORY.270) -- (LAND.90) node[midway, rotate=90, left, above] {update $w$};
    \draw[-latex, thick] (LAND.270) -- (SURF.90);
    \draw[-latex, thick] (SURF.270) |- +(-2.5,-0.5) -- node[rotate=90, left, above] {thermal desorption; photodesorption; sputtering} node[midway, rotate=90, left, below] {update $w$} ($(LAUNCH.90)+(-2.5,0.5)$) -| (LAUNCH.110);

    %::. add nodes
    \node[right = 2.8 of LAUNCH] (ADD1) {add to $\surfaceNumberDensity$};
    \node[right = 3.2 of LAND] (ADD2) {add to $\surfaceNumberDensity$};

    %::. add connections
    \draw[-latex, thick] (LAUNCH.0) -- (ADD1.180);
    \draw[-latex, thick] (LAND.0) -- (ADD2.180);

    %::. loss nodes
    \node[right = 3 of TRAJECTORY] (ESCAPE) {\n{escape}};
    \node[right = 3 of SURF] (TRAP) {\n{cold \\ trapping}};

    %::. loss connections
    \draw[-latex, thick] (TRAJECTORY) -- (ESCAPE) node[midway, above]{$\velocity \geq \velocity_{esc}$};
    \draw[-latex, thick] (SURF) -- (TRAP);

    %::. conversion nodes
    \node[below left = 0.5 and -1 of ESCAPE, text=TUMOrange] (PHOTO) {\textit{\n{photo- \\ dissociation}}};
    \node[below left = 0.6 and -1 of TRAP, text=TUMOrange] (CONV) {\textit{\n{(sub-) surface \\ reaction}}};
    \node[below = 0.6 of CONV, text=TUMOrange] (ADPHOTO) {\textit{\n{adsorbate \\ photodissociation}}};

    \node[right = 5.5 of LAUNCH, text=TUMOrange] (STORE) {\textit{\n{store converted \\ particles for \\ next iteration}}};

    %::. conversion connections
    \draw[-latex, thick, dashed, TUMOrange] (TRAJECTORY.300) |- (PHOTO);
    \draw[-latex, thick, dashed, TUMOrange] (SURF.310) |- (CONV);
    \draw[-latex, thick, dashed, TUMOrange] (SURF.290) |- (ADPHOTO);

    \draw[-latex, thick, dashed, TUMOrange] (PHOTO) -| (STORE.250);
    \draw[-latex, thick, dashed, TUMOrange] (CONV) -| (STORE.270);
    \draw[-latex, thick, dashed, TUMOrange] (ADPHOTO) -| (STORE.290);

    %::. background loop node
    \begin{pgfonlayer}{background}
        \draw[thick, fill=white!95!black, rounded corners=4pt] ($(LAUNCH.135) - (3,-1.75)$) -| ($(ADPHOTO) + (2.5,11)$) |- ($(ADD1.north west) + (-0.75, 0.3)$) |- ($(ESCAPE.south) + (0, -0.3)$) -| ($(ADPHOTO) + (2.5,6)$) |- ($(ADD2.north west) + (-0.5, 0.3)$) |- ($(TRAP.south) + (0, -0.3)$) -| ($(ADPHOTO) + (2.5,-0.7)$) -| ($(LAUNCH.135) - (3,5)$) -- cycle;
        \node[anchor=north east, text=TUMBlueDark] at ($(LAUNCH.90) + (7, 1.75)$) {\n{\textbf{Loop I} \\ Exospheric Particle Transport \\ and Surface Interactions}};
    \end{pgfonlayer}
    
\end{tikzpicture}
```

Note that the used mathematical symbols and colors are defined in the preamble of the document, e.g. `\newcommand{\velocity}{v}`.

# {{< bi download >}} Download

* {{< downloadthis imgs/model_architecture/loop_I.pdf label="loop_I.pdf" type="light" dname="loop_I" >}} {{< downloadthis imgs/model_architecture/loop_I.svg label="loop_I.svg" type="light" dname="loop_I" >}}  {{< downloadthis imgs/model_architecture/loop_I.png label="loop_I.png" type="light" dname="loop_I" >}}

:::




::: {.panel-tabset}

# {{< bi image >}} Figure

::: {#fig-loop-II }
![](imgs/model_architecture/loop_II.svg){width="643px"}

The second inner loop of the model architecture is iterating new particle launches over every grid element with an individual and grid element area-dependent weight. The orange highlighted path indicates the conversion of the exospheric species into other species, e.g. the photodissociation of water into atomic hydrogen and hydroxyl, which has been carried over from the inner loop, see @fig-loop-I.
:::

# {{< bi code >}} LaTeX
```latex
\newcommand{\n}[1]{\begin{tabular}{c}#1\end{tabular}}
\renewcommand{\vec}[1]{\boldsymbol{\mathbf{#1}}}

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}

\begin{tikzpicture}[
    main/.style={draw, thick, rounded corners=4pt, inner sep=2pt, minimum size=20pt, minimum width=25pt, fill=white},
]

    %::. main nodes
    \node[main] (LOOPI) at (0,0) {\n{\textbf{Loop I} \\ Exospheric Particle Transport \\ and Surface Interactions}};
    \node[main, above = of LOOPI] (W0) {\n{Calculate inital \\ weight $\weight_0 = \dot{\source}^{(j)}$}};
    \node[main, above = of W0] (PREP) {\n{Prepare start of \\ new particle from $k$-th \\ grid element at $\sphericalCoordinateAzimuth_0, \sphericalCoordinateElevation_0$.}};
    \node[right = 1.5 of LOOPI] (SUM) {\n{Sum the results \\ of all particles}};

    %::. main connections
    \draw[-latex, thick] (W0.270) -- (LOOPI.90);
    \draw[-latex, thick] (PREP.270) -- (W0.90);
    \draw[-latex, thick] (LOOPI.240) -- +(0,-0.5) -| ($(PREP.120) + (-3,0.5)$) node[near end, rotate=90, left, above] {escape; cold trapping; $\weight/\weight_0$ below treshold} -| (PREP.120) node[near start, above] {$k\mapsto k+1$};
    \draw[-latex, thick] (LOOPI.0) -- (SUM.180);

    \draw[-latex, thick] (PREP.0) -- +(5,0) node[midway, below]{$k > N_\text{grid}$};

    %::. conversion node from Loop I
    \node[below = 1.5 of LOOPI, text=TUMOrange] (STORE) {\textit{\n{store converted \\ particles for \\ next iteration}}};
    \draw[-latex, thick, dashed, TUMOrange] (LOOPI.270) -- (STORE.90);

    %::. input connection
    \draw[latex-, thick] (PREP.90) -- +(0,2) node[midway, right, yshift=-7px]{$k=1$} node[at end, above] {\n{New, $j$-th iteration with \\ element $e \in \left\{\ce{H}, \ce{H2}, \ce{OH}, \ce{H2O}\right\}$}};

    %::. background loop node
    \begin{pgfonlayer}{background}
        \draw[thick, fill=white!95!black, rounded corners=4pt] ($(PREP.135) - (3.5,-1.1)$) -| ($(PREP.0) + (4,0)$) |- ($(SUM.north west) + (-0.5, 1)$) |- ($(LOOPI.south east) + (0,-0.75)$) -| ($(PREP.135) - (3.5,5)$) -- cycle;
        \node[anchor=north east, text=TUMBlueDark] at ($(PREP.90) + (6, 1)$) {\n{\textbf{Loop II} \\ Weighted Launches from \\ Numerical Grid}};
    \end{pgfonlayer}
\end{tikzpicture}
```

Note that the used mathematical symbols and colors are defined in the preamble of the document, e.g. `\newcommand{\velocity}{v}`.

# {{< bi download >}} Download

* {{< downloadthis imgs/model_architecture/loop_II.pdf label="loop_II.pdf" type="light" dname="loop_II" >}} {{< downloadthis imgs/model_architecture/loop_II.svg label="loop_II.svg" type="light" dname="loop_II" >}}  {{< downloadthis imgs/model_architecture/loop_II.png label="loop_II.png" type="light" dname="loop_II" >}}

:::




::: {.panel-tabset}

# {{< bi image >}} Figure

::: {#fig-loop-II }
![](imgs/model_architecture/loop_III.svg){width="630px"}

The third loop of the model architecture is iterating over all elements and all iterations of the second loop. The orange highlighted path indicates the conversion of the exospheric species into other species, which has been carried over from the innermost loop, see @fig-loop-I. These converted particles act as a new input of source rates $\dot\source$ for subsequent iterations. Each result of the second loop is summed up to a single result for each element.
:::

# {{< bi code >}} LaTeX
```latex
\newcommand{\n}[1]{\begin{tabular}{c}#1\end{tabular}}
\renewcommand{\vec}[1]{\boldsymbol{\mathbf{#1}}}

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}

\begin{tikzpicture}[
    main/.style={draw, thick, rounded corners=4pt, inner sep=2pt, minimum size=20pt, minimum width=25pt, fill=white},
]

    %::. main nodes
    \node[main] (LOOPII) at (0,0) {\n{\textbf{Loop II} \\ Weighted Launches from \\ Numerical Grid}};
    \node[main, above = of LOOPII] (ELEMS) {\n{Prepare start of $j$-th \\ iteration of element \\ $e \in \left\{\ce{H}, \ce{H2}, \ce{OH}, \ce{H2O}\right\}$}};
    \node[main, above = 1.5 of ELEMS] (ITERATION) {\n{Prepare $j$-th \\ iteration: $\dot\source^{(j)}$}};

    %::. main connections
    \draw[-latex, thick] (ELEMS.270) -- (LOOPII.90);
    \draw[-latex, thick] (ITERATION.270) -- (ELEMS.90);

    \draw[-latex, thick] (LOOPII.240) |- +(-1,-0.5) -| node[near end, left, above, rotate=90] {next element} ($(ELEMS.120) + (-2.1, 0.5)$) -| (ELEMS.120);

    \draw[-latex, thick, TUMOrange, dashed] (LOOPII.297) |- +(-1,-0.95) -| node[near end, left, below, rotate=90] {\emph{use converted particles for next $\dot\source$}} ($(ITERATION.123) + (-3.425, 0.45)$) -| (ITERATION.123);
    \draw[-latex, thick] (LOOPII.300) |- +(-1,-1) -| node[near end, left, above, rotate=90] {sum the results of all particles} ($(ITERATION.120) + (-3.5, 0.5)$) -| (ITERATION.120) node[near start, above] {$j\mapsto j+1$};

    \draw[-latex, thick] (ITERATION.0) -- +(5,0) node[midway, below]{$j > N_\text{iter}$} node[at end, right] {end loop};

    %::. exit node
    \node[right = 2 of LOOPII] (SUM) {\n{Sum the results \\ of all iterations}};

    %:: exit node connection
    \draw[-latex, thick] (LOOPII.0) -- (SUM.180);

    %::. input connection
    \draw[latex-, thick] (ITERATION.90) -- +(0,2) node[midway, right, yshift=-7px]{$j=1$} node[at end, above] {\n{Next $i$-th \\ Monte-Carlo step}};


    %::. background loop node
    \begin{pgfonlayer}{background}
        \draw[thick, fill=white!95!black, rounded corners=4pt] ($(ITERATION.135) - (4.5,-1.1)$) -| ($(ITERATION.0) + (4,0)$) |- ($(SUM.north west) + (-0.5, 1)$) |- ($(LOOPII.south east) + (0,-1.5)$) -| ($(ITERATION.135) - (4.5,5)$) -- cycle;
        \node[anchor=north east, text=TUMBlueDark] at ($(ITERATION.90) + (5.2, 1)$) {\n{\textbf{Loop III} \\ Iterations and Elements}};
    \end{pgfonlayer}
\end{tikzpicture}
```

Note that the used mathematical symbols and colors are defined in the document's preamble, e.g., `\newcommand{\velocity}{v}`.

# {{< bi download >}} Download

* {{< downloadthis imgs/model_architecture/loop_III.pdf label="loop_III.pdf" type="light" dname="loop_III" >}} {{< downloadthis imgs/model_architecture/loop_III.svg label="loop_III.svg" type="light" dname="loop_III" >}}  {{< downloadthis imgs/model_architecture/loop_III.png label="loop_III.png" type="light" dname="loop_III" >}}

:::



::: {.panel-tabset}

# {{< bi image >}} Figure

::: {#fig-loop-II }
![](imgs/model_architecture/loop_IV.svg){width="549px"}


Fourth and outermost loop of the model architecture. This loop handles the actual Monte-Carlo simulation by iterating over all $N_{MC}$ steps, each with an identical setup, and saving the outcome of each step separately to perform any statistical analyses and post-processing afterwards.
:::

# {{< bi code >}} LaTeX
```latex
\newcommand{\n}[1]{\begin{tabular}{c}#1\end{tabular}}
\renewcommand{\vec}[1]{\boldsymbol{\mathbf{#1}}}

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}

\begin{tikzpicture}[
    main/.style={draw, thick, rounded corners=4pt, inner sep=2pt, minimum size=20pt, minimum width=25pt, fill=white},
]

    %::. main nodes
    \node[main] (LOOPIII) at (0,0) {\n{\textbf{Loop III} \\ Iterations and Elements}};
    \node[main, above = of LOOPIII] (STEP) {\n{Start $i$-th \\ Monte-Carlo step}};
    \node[above = 1.5 of STEP] (START) {Start simulation};

    %::. main connections
    \draw[-latex, thick] (STEP.270) -- (LOOPIII.90);
    \draw[-latex, thick] (START.270) -- (STEP.90) node[midway, right, yshift=0px]{$i=1$};
    \draw[-latex, thick] (LOOPIII.240) |- +(-1,-0.5) -| node[near end, left, above, rotate=90] {sum the results of all iterations} ($(STEP.120) + (-2.1, 0.5)$) -| (STEP.120)  node[near start, above] {$i\mapsto i+1$};

    %::. save node
    \node[below = 1.5 of LOOPIII] (SAVE) {\n{Save $\surfaceNumberDensity$ results \\ of $i$-th Monte-Carlo step}};

    %:: save node connection
    \draw[-latex, thick] (LOOPIII.290) -- (SAVE.70);

    %::. end node
    \node[right = 3.5 of STEP] (END) {End simulation};

    %::. end connection
    \draw[-latex, thick] (STEP.0) -- (END) node[midway, below]{$i > N_\text{MC}$};

    %::. postprocessing node
    \node[main, double, right = 1.5 of SAVE] (PP) {\n{Post-processing: \\ calculate $\mean$ and $\standardDeviation$ of all $\surfaceNumberDensity^{(i)}$}};

    %::. postprocessing connection
    \draw[-latex, thick, double] (SAVE.0) -- (PP.180);
    \draw[-latex, thick, double] (END.212) -- (PP);

    %::. background loop node
    \begin{pgfonlayer}{background}
        \draw[thick, fill=white!95!black, rounded corners=4pt] ($(STEP.90) + (0,1)$) -| ($(STEP.0) + (3.2,0.3)$) -| ($(LOOPIII.0) + (0.25,0)$) |- ($(LOOPIII.270) + (0,-1)$) -| ($(STEP.180) + (-1.5,0)$) |- ($(STEP.90) + (-1,1)$) -- cycle;
        \node[anchor=north east, text=TUMBlueDark] at ($(STEP.90) + (4.7, 1)$) {\n{\textbf{Loop IV} \\ Monte-Carlo Steps}};
    \end{pgfonlayer}
\end{tikzpicture}
```

Note that the used mathematical symbols and colors are defined in the preamble of the document, e.g. `\newcommand{\velocity}{v}`.

# {{< bi download >}} Download

* {{< downloadthis imgs/model_architecture/loop_IV.pdf label="loop_IV.pdf" type="light" dname="loop_IV" >}} {{< downloadthis imgs/model_architecture/loop_IV.svg label="loop_IV.svg" type="light" dname="loop_IV" >}}  {{< downloadthis imgs/model_architecture/loop_IV.png label="loop_IV.png" type="light" dname="loop_IV" >}}

:::