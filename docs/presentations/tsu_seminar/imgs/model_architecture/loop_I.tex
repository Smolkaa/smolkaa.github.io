\documentclass[crop,tikz,10pt]{standalone}
\usepackage{tikz}
	\usetikzlibrary{shapes}
	\usetikzlibrary{automata}
	\usetikzlibrary{arrows}
	\usetikzlibrary{backgrounds}
	\usetikzlibrary{calc}
	\usetikzlibrary{positioning}
	\usetikzlibrary{patterns}
	\usetikzlibrary{decorations.pathmorphing}
	\usetikzlibrary{decorations.pathreplacing}

\usepackage[scaled]{helvet}
\renewcommand{\familydefault}{\sfdefault}

\usepackage{booktabs}
\usepackage{bm}
\usepackage{siunitx}
\usepackage{xcolor}
    \definecolor{TUMOrange}{RGB}{227, 114, 34}
    \definecolor{TUMBlueDark}{RGB}{0, 82, 147}

\input{../../../../resources/latex/_symbols.qmd}

\begin{document}

\newcommand{\n}[1]{\begin{tabular}{c}#1\end{tabular}}
\renewcommand{\vec}[1]{\boldsymbol{\mathbf{#1}}}
    
\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}

\begin{tikzpicture}[
    main/.style={draw, thick, rounded corners=4pt, inner sep=2pt, minimum size=20pt, minimum width=25pt, fill=white},
]

    %::. main nodes
    \node[main] (LAUNCH) at (0,0) {\n{Launch particle at $\sphericalCoordinateAzimuth_0, \sphericalCoordinateElevation_0$ \\ with $\vec\velocity \sim \Velocity_\text{MBF}$}};
    \node[main, below = 0.8 of LAUNCH] (TRAJECTORY) {\n{Calculate landing \\ position $\sphericalCoordinateAzimuth_1, \sphericalCoordinateElevation_1$ \\ and time-of-flight $\Time_f$}};
    \node[main, below = 2 of TRAJECTORY] (LAND) {\n{Landing at $\sphericalCoordinateAzimuth_1, \sphericalCoordinateElevation_1$}};
    \node[main, below = 0.8 of LAND] (SURF) {\n{Surface interactions \\ at $\sphericalCoordinateAzimuth_1, \sphericalCoordinateElevation_1$}};

    %::. main connections
    \draw[latex-, thick] (LAUNCH.70) -- +(0,2.5) node[at end, above] {\n{New particle with \\ weight $\weight = \weight_0$}};

    \draw[-latex, thick] (LAUNCH.270) -- (TRAJECTORY.90);
    \draw[-latex, thick] (TRAJECTORY.270) -- (LAND.90) node[midway, rotate=90, left, above] {update $w$};
    \draw[-latex, thick] (LAND.270) -- (SURF.90);
    \draw[-latex, thick] (SURF.270) |- +(-2.5,-0.5) -- node[rotate=90, left, above] {thermal desorption; photodesorption; sputtering} node[midway, rotate=90, left, below] {update $w$} ($(LAUNCH.90)+(-2.5,0.5)$) -| (LAUNCH.110);

    %::. add nodes
    \node[right = 0.5 of LAUNCH] (ADD1) {$\surfaceNumberDensity \mapsto \surfaceNumberDensity + \frac{\weight}{\area\velocity}$};
    \node[right = 0.9 of LAND] (ADD2) {$\surfaceNumberDensity \mapsto \surfaceNumberDensity + \frac{\weight}{\area\velocity}$};

    %::. add connections
    \draw[-latex, thick, double] (LAUNCH.0) -- (ADD1.180);
    \draw[-latex, thick, double] (LAND.0) -- (ADD2.180);

    %::. loss nodes
    \node[right = 4.5 of TRAJECTORY] (ESCAPE) {\n{escape}};
    \node[right = 4.5 of SURF] (TRAP) {\n{cold \\ trapping}};

    %::. loss connections
    \draw[-latex, thick] (TRAJECTORY) -- (ESCAPE) node[midway, above]{$\velocity \geq \velocity_{esc}$};
    \draw[-latex, thick] (SURF) -- (TRAP);

    %::. conversion nodes
    \node[below = 0.5 of ESCAPE, text=TUMOrange] (PHOTO) {\textit{\n{photo- \\ dissociation}}};
    \node[below = 0.8 of TRAP, text=TUMOrange] (CONV) {\textit{\n{(sub-) surface \\ reaction}}};
    \node[below = 0.5 of CONV, text=TUMOrange] (ADPHOTO) {\textit{\n{adsorbate \\ photodissociation}}};

    \node[right = 6.0 of LAUNCH, text=TUMOrange] (STORE) {\textit{\n{store converted \\ particles for \\ next iteration}}};

    %::. conversion connections
    \draw[-latex, thick, dashed, TUMOrange] (TRAJECTORY.300) |- (PHOTO);
    \draw[-latex, thick, dashed, TUMOrange] (SURF.310) |- (CONV);
    \draw[-latex, thick, dashed, TUMOrange] (SURF.290) |- (ADPHOTO);

    \draw[-latex, thick, dashed, TUMOrange] (PHOTO) -| (STORE.250);
    \draw[-latex, thick, dashed, TUMOrange] (CONV) -| (STORE.270);
    \draw[-latex, thick, dashed, TUMOrange] (ADPHOTO) -| (STORE.290);

    %::. background loop node
    \begin{pgfonlayer}{background}
        \draw[thick, fill=white!95!black, rounded corners=4pt] ($(LAUNCH.135) - (3,-1.75)$) rectangle ($(SURF.270) + (5.25,-1)$);
        \node[anchor=north east, text=TUMBlueDark] at ($(LAUNCH.90) + (5.25, 1.75)$) {\n{\textbf{Loop I} \\ Exospheric Particle Transport \\ and Surface Interactions}};
    \end{pgfonlayer}
    
\end{tikzpicture}

\end{document}